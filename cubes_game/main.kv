<CubesGame>:
    time: 0
    task_counter: 0
    mega_task_counter: 0
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: .35
#            height: WINDOW.height - (rl.height + (WINDOW.width / 6) *2)  # * 3)
            canvas:
                Color:
                    rgba: (.36, .17, .05, 1)
                Rectangle:
                    size: self.size
                    pos: self.pos
            StackLayout: # status board
                size_hint_y: None
                height: WINDOW.width / 6
                canvas:
                    Color:
                        rgba: (.30, .12, .03, 1)
                    Rectangle:
                        size: self.size
                        pos: self.pos
                Button:
                    text: '<<back'
                    size_hint_x: .2
                    color: (1, .5, 0, 1)
                    background_normal: ''
                    background_color: (.30, .12, .03, 1)
                    on_press: root.dismiss()
                Button:
                    border: [0, 0, 0, 0]
                    size_hint: None, None
                    size: WINDOW.width / 6, WINDOW.width / 6
                    background_normal: 'images/crystal.png'
                    background_down: 'images/crystal.png'
                    on_press: root.open_shop()

            BoxLayout:
                RelativeLayout:
                    id: info_box
                    size_hint_x: .65
                    BoxLayout:
                        orientation: 'vertical'
                        GridLayout:
                            size_hint_y: .62
                            cols: 1
                            spacing: 5
                            padding: 5
                            canvas.before:
                                Color:
                                    rgba: (.3, .3, .3, .2)
                                Rectangle:
                                    size: self.size
                                    pos: self.pos
                            BoxLayout:
                                size_hint_y: .24
                                orientation: 'vertical'
                                BoxLayout:
                                    orientation: 'vertical'
                                    BoxLayout:
                                        Label:
                                            id: score_label
                                            color: (1, .5, 0, 1)
                                            text_size: self.size
                                            halign: 'right'
                                            valign: 'middle'
                                        Label:
                                            size_hint_x: .2
                                            text: '/'
                                            color: (1, .5, 0, 1)
                                        Label:
                                            id: max_score_label
                                            color: (1, .5, 0, 1)
                                            text_size: self.size
                                            halign: 'left'
                                            valign: 'middle'
                                    ProgressBar:
                                        id: progress
                            BoxLayout:
                                size_hint_y: .38
                                BoxLayout:
                                    Button:
                                        id: task_label
                                        size_hint_x: None
                                        width: self.height
                                        background_normal: ''
                                        background_down: self.background_normal
                                        background_color: (1, 0, 0, 1)
                                        border: (0, 0, 0, 0)
                                    Button:
                                        background_normal: ''
                                        background_down: self.background_normal
                                        background_color: (0, 0, 0, 0)
                                        text: str(root.task_counter)  if root.task_counter > 0 else ''
                                        color: (1, .5, 0, 1)
                                BoxLayout:
                                    Button:
                                        id: mega_task_label
                                        size_hint_x: None
                                        width: self.height
                                        background_normal: ''
                                        background_down: self.background_normal
                                        background_color: (0, 1, 0, 1)
                                        border: (0, 0, 0, 0)
                                    Button:
                                        background_normal: ''
                                        background_down: self.background_normal
                                        background_color: (0, 0, 0, 0)
                                        text: str(root.mega_task_counter)  if root.mega_task_counter > 0 else ''
                                        color: (1, .5, 0, 1)
                        BoxLayout:
                            size_hint_y: .38
                            spacing: 5
                            padding: 5
                            BoxLayout:
                                Button:
                                    size_hint_x: None
                                    width: self.height
                                    background_normal: 'images/info_and_tasks/swipe.png'
                                    background_down: self.background_normal
                                    background_color: (1, 1, 1, 1)
                                    border: (0, 0, 0, 0)
                                Button:
                                    id: swipes_label
                                    background_normal: ''
                                    background_down: self.background_normal
                                    background_color: (0, 0, 0, 0)
                                    text: '15'
                                    color: (1, .5, 0, 1)
                            BoxLayout:
                                Button:
                                    size_hint_x: None
                                    width: self.height
                                    background_normal: 'images/info_and_tasks/clock.png'
                                    background_down: self.background_normal
                                    background_color: (1, 1, 1, 1)
                                    border: (0, 0, 0, 0)
                                Button:
                                    id: time_label
                                    background_normal: ''  if root.time != -1 else 'images/info_and_tasks/time_infinitely.png'
                                    background_down: self.background_normal
                                    background_color: (0, 0, 0, 0) if root.time != -1 else (1, 1, 1, 1)
                                    border: (0, 0, 0, 0)
                                    text: str(format(root.time, '.2f')) if root.time != -1 else ''
                                    color: (1, .5, 0, 1)
                    Image:
                        id: combo
                        size_hint: None, None
                        size: info_box.size
                        source: 'images/combo/combo22.png'
                        color: (1, 1, 1, 0)
                RelativeLayout:
                    size_hint_x: .35
                    Companion:
                        id: companion
                        background_normal: 'images/companion.png'
                    Character:
                        id: character
                        size_hint: None, None
                        size: WINDOW.width / 7, WINDOW.height / 9
                        pos_hint: {'right': 1}
                    CharacterLevelButton:
                        id: character_level
                        size_hint: None, None
                        size: WINDOW.width / 15, WINDOW.width / 15
                        pos_hint: {'right': 1}
                        on_press: self.open_character_level_info(character.name)


        BoxLayout:
            orientation: 'vertical'
            size_hint_y: .65
#            height: rl.height + (WINDOW.width / 6) * 2
            AnchorLayout:
                size_hint_y: .15
#                height: WINDOW.width / 6
                canvas:
                    Color:
                        rgba: (.30, .12, .03, 1)
                    Rectangle:
                        size: self.size
                        pos: self.pos
                BoxLayout:
                    id: skills
                    size_hint_x: None
                    width: self.minimum_width
                    spacing: WINDOW.width / 20
                    padding: WINDOW.width / 30
            AnchorLayout:
                size_hint_y: .85
#                height: rl.height + WINDOW.width / 6
                canvas:
                    Color:
                        rgba: (.36, .17, .05, 1)
                    Rectangle:
                        size: self.size
                        pos: self.pos
                anchor_x: 'center'
                anchor_y: 'center'
                RelativeLayout:
                    id: rl
                    size_hint: None, None
                    StencilView: # field with cubes
                        id: playing_field
                        canvas:
                            Color:
                                rgba: (.30, .12, .03, 1)
                            Rectangle:
                                size: self.size
                                pos: self.pos

<Character>:
    on_press: root.open_character_changer()
    border: [0, 0, 0 ,0]

<Companion@Button>:
#    on_press: root.open_character_changer()
    border: [0, 0, 0 ,0]

<Character2>:
    on_press: root.open_character_changer(change_skills=False)
    border: [0, 0, 0 ,0]

<SkillBox>:
    size_hint_x: None
    width: self.height
    RelativeLayout:
        Skill:
            id: skill
            quantity: 0
        Label:
            id: quantity
            text: str(skill.quantity)
            size_hint: None, None
            size: self.texture_size
            x: skill.x - self.width / 2
            y: skill.y - self.height / 2
            color: (1, 1, 1, 1)
            canvas.before:
                Color:
                    rgba: (.49, .42, .88, 1)
                Ellipse:
                    pos: self.center_x - self.height / 2, self.y
                    size: self.height, self.height

<Skill>:
    border: [0, 0, 0, 0]
    background_down: self.background_normal
    background_color: (0, 0, 0, 1)
    on_state: self.change_color()
    c: (.88, .72, .31, 1)
    canvas.before:
        Color:
            rgba: self.c
        RoundedRectangle:
            size: self.size[0] * 1.2, self.size[1] * 1.2
            pos: self.pos[0] - self.size[0] * .1, self.pos[1] - self.size[1] * .1
            radius: [self.height / 5,]

<CharacterChanger>:
    size_hint_y: WINDOW.width / WINDOW.height / 3
    size_hint_x: .8
    background: ''
    canvas:
        Color:
            rgba: (.30, .12, .03, 1)
        Rectangle:
            size: self.size
            pos: self.pos
    GridLayout:
        id: character_selection
        cols: 3
        spacing: WINDOW.width / 60
        padding: WINDOW.width / 60



<StartingPoint>:
    size_hint: None, None
    canvas:
        Ellipse:
            pos: self.pos
            size: self.size
        Color:
            rgba: 1, 0, 0, 1

<GameEnding>:
    size_hint: .8, .8
    BoxLayout:
        orientation: 'vertical'
        Label:
            id: lbl
            text: 'GG! Your score is: 0'
        Label:
            id: stars
        BoxLayout:
            BoxLayout:
                size_hint_x: .6
                orientation: 'vertical'
                BoxLayout:
                    orientation: 'vertical'
                    Label:
                        text: 'exp: '
                    Label:
                        id: exp
                BoxLayout:
                    orientation: 'vertical'
                    Label:
                        text: 'crystal fragments: '
                    Label:
                        id: gold
            Character2:
                id: character
                size_hint_x: .4
        Button:
            text: 'Play again'
            on_press: root.play_again()
        Button:
            text: 'Exit'
            on_press: root.exit_level()

<Cube>:
    border: (0, 0, 0, 0)
#    color: (0, 0, 0, 0)
    pattern: 'images/patterns/square'
    background_down: self.pattern + self.text if self.text != '' else '0' + '.png'
    background_normal: self.pattern + self.text if self.text != '' else '0' + '.png'
    on_pattern: self.change_pattern()
    on_text: self.change_pattern()


<CharacterLevelButton>:
    background_color: (0, 0, 0, 0)
    canvas.before:
        Color:
            rgba: (1, 0, 0, 1)
        Ellipse:
            pos: self.pos
            size: self.size
    background_normal: ''
    background_down: ''
    text: ''


<CharacterLevelInfo>:
    size_hint: .8, .3
    BoxLayout:
        Label:
            id: character_level
        Label:
            id: exp